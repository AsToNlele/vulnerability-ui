import React from 'react';
import { ExclamationCircleIcon } from '@patternfly/react-icons';
import { Alignment, Bullseye } from '@patternfly/react-core';
import _ from 'lodash';
import { PropagateLoader } from 'react-spinners';

export function getVMaaSCVEs(apiProps) {
    apiProps = { ...apiProps, cve_list: optimizeCveList(apiProps.cve_list) };
    return fetch('https://webapp-vmaas-ci.1b13.insights.openshiftapps.com/api/v1/cves/', {
        method: 'post',
        headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(apiProps)
    })
    .then(function(res) {
        return res.json();
    })
    .then(function(resJson) {
        return processRawCVEs(resJson);
    });
}

export async function getCVEsWithSystems(props) {
    let cves_with_systems = [];
    let cve_list = ['CVE-2017-5715', 'CVE-2017-5753', 'CVE-2017-5754', 'CVE-2017-5756', 'CVE-2018-10931'];
    let cves = await getVMaaSCVEs({ cve_list });
    cves_with_systems = Object.values(cves).map(item => {
        return { ...item, systems: getNumberOfAffectedSystems(item.synopsis) };
    });
    return cves_with_systems;
}

export function getNumberOfAffectedSystems(cve) {
    let number = getDemoCVESystem().filter(item => {
        return item.cve === cve;
    });
    number = [...new Set(number.map(item => item.system))];
    return number.length;
}

export function createCveWithSystemsTable(cves) {
    let modCves = Object.values(cves);
    modCves = modCves.map(cve => {
        return {
            impact: processImpactForTable(cve.impact),
            synopsis: processSynopsisForTable(cve.synopsis),
            systems: processSystemsForTable(cve.systems),
            total_risk: cve.total_risk,
            description: truncate(cve.description, 120)
        };
    });
    let table = modCves.map(cve => {
        return { cells: Object.values(cve), synopsis: cve.synopsis.props.children.props.children };
    });
    return table;
}

function getAffectedSystems(cve) {
    let systems = getDemoCVESystem()
    .filter(item => {
        return item.cve === cve;
    })
    .map(single => single.system);
    return systems;
}

export function createExposedSystemsTable(cves) {
    if (cves.isLoading) {
        return;
    }

    let singleCve = cves.items[0];
    let affectedSystems = [...new Set(getAffectedSystems(singleCve.synopsis))];
    return affectedSystems.map(system => {
        return { cells: [system] };
    });
}

export function createCveDetailsPage(cves) {
    if (_.isEmpty(cves.items)) {
        return {};
    }

    let singleCve = cves.items[0];
    let isLoading = cves.isLoading;
    return {
        impact: processImpactForTable(singleCve.impact),
        public_date: processDate(singleCve.public_date),
        description: singleCve.description,
        synopsis: singleCve.synopsis,
        isLoading
    };
}

export function withLoader(prop, isLoading) {
    if (isLoading !== false) {
        return (
            <Bullseye>
                <PropagateLoader color={'#00b9e4'} loading={true} />
            </Bullseye>
        );
    } else {
        return prop;
    }
}

function processSynopsisForTable(synopsis) {
    return (
        <Alignment align="center">
            <b>{synopsis}</b>
        </Alignment>
    );
}

function truncate(str, max) {
    return str.length > max ? str.substr(0, max - 1) + 'â€¦' : str;
}

function processSystemsForTable(number) {
    return (
        <React.Fragment>
            <Alignment align="center">
                <b>{number}</b>
                <br />Systems/Groups
            </Alignment>
        </React.Fragment>
    );
}

function optimizeCveList(cveList) {
    return cveList;
}

export function processRawCVEs(rawcves) {
    let cveItems = [];
    for (let row in rawcves.cve_list) {
        let newRow = processCVErow(row, rawcves.cve_list[row]);
        cveItems.push(newRow);
    }

    return {
        ...cveItems
    };
}

function processCVErow(key, data) {
    let modifiedData = {
        ...data,
        synopsis: data.synopsis,
        cwe_list: data.cwe_list,
        public_date: data.public_date,
        modified_date: data.modified_date,
        impact: data.impact,
        redhat_url: data.redhat_url,
        secondary_url: data.secondary_url
    };
    return modifiedData;
}

function processDate(dateString) {
    let date = new Date(dateString);
    return date.toLocaleDateString();
}

function processImpactForTable(impact) {
    switch (impact) {
        case 'High':
        case 'Important':
            return (
                <span>
                    <ExclamationCircleIcon size="lg" color={'var(--pf-global--warning-color--100)'} title={impact} />
                    {impact}
                </span>
            );
        case 'Medium':
        case 'Moderate':
            return (
                <span>
                    <i className="fas fa-exclamation-circle" /> {impact}
                </span>
            );
        case 'Critical':
            return (
                <span>
                    <i className="fas fa-exclamation-circle" style={{ color: '#c00' }} /> {impact}
                </span>
            );
        case 'Low':
            return (
                <span>
                    <i className="fas fa-exclamation-circle" style={{ color: '#72767b' }} /> {impact}
                </span>
            );
    }
}

function getDemoCVESystem() {
    return [
        {
            system: 'pontchartrain.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'verret.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'greenbo.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'crater.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'huron.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'travis.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'sakakawea.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'heron.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'eagle.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'candlewood.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'cedar.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'sabbatia.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'lurleen.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'redfish.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'ontario.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'seminole.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'wilson.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'rend.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'crater.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'tule.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'sunapee.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'fenton.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'houghton.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'shasta.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'higgins.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'trinity.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'saugatuck.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'ozarks.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'sabine.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'action.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'crystal.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'tule.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'harris.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'emporia.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'como.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'cedar.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'enid.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'wheeler.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'delta.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'elk.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'hauser.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'minnetonkas.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'alturas.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'bantam.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'isabella.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'cedar.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'wilson.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'marion.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'emporia.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'hauser.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'kickapoo.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'tahoe.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'meade.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'tupper.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'greers.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'pontchartrain.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'placid.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'hartwell.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'pleasant.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'trinity.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'candlewood.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'sawtooth.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'texoma.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'mono.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'ute.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'beshear.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'holt.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'emporia.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'stump.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'beshear.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'bantam.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'bluestone.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'champlain.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'wheeler.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'fairfax.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'kickapoo.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'wilson.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'george.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'houghton.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'ontario.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'wilson.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'crater.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'bantam.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'shasta.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'peck.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'elk.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'shasta.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'fallriver.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'cedar.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'saugatuck.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'burke.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'greenbo.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'donner.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'sawtooth.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'bluestone.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'baron.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'minnetonkas.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'caddo.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'sabbatia.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'crystal.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'burke.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'cypress.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'navajo.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'meade.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'burke.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'storm.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'perry.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'sakakawea.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'zoar.example.redhat.com',
            cve: 'CVE-2017-5756'
        }
    ];
}
