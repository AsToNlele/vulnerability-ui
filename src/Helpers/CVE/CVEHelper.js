import React from 'react';
import { Alignment, Bullseye } from '@patternfly/react-core';
import { Battery } from '@red-hat-insights/insights-frontend-components';
import _ from 'lodash';
import { PropagateLoader } from 'react-spinners';
import { LaptopIcon, ExclamationTriangleIcon } from '@patternfly/react-icons';

export function getVMaaSCVEs(apiProps) {
    apiProps = { ...apiProps, cve_list: optimizeCveList(apiProps.cve_list) };
    return fetch('https://webapp-vmaas-ci.1b13.insights.openshiftapps.com/api/v1/cves/', {
        method: 'post',
        headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(apiProps)
    })
    .then(function(res) {
        return res.json();
    })
    .then(function(resJson) {
        return processRawCVEs(resJson);
    });
}

export async function getCVEsWithSystems() {
    let cvesWithSystems = [];
    let cveList = [
        'CVE-2017-5715',
        'CVE-2017-5753',
        'CVE-2017-5754',
        'CVE-2017-5756',
        'CVE-2018-10931',
        'CVE_2015_3456',
        'CVE_2015_3456',
        'CVE_2015_7547',
        'CVE-2016-0800',
        'CVE_2016_3714',
        'CVE-2014-0160',
        'CVE-2018-1102',
        'CVE-2018-2814',
        'CVE-2017-1000502',
        'CVE-2018-10908',
        'CVE-2018-4117'
    ];
    let cves = await getVMaaSCVEs({ cve_list: cveList });
    cvesWithSystems = Object.values(cves).map(item => {
        return { ...item, systems: getNumberOfAffectedSystems(item.synopsis) };
    });
    return cvesWithSystems;
}

export function getNumberOfAffectedSystems(cve) {
    let number = getDemoCVESystem().filter(item => {
        return item.cve === cve;
    });
    number = [...new Set(number.map(item => item.system))];
    return number.length;
}

export function createCveWithSystemsTable(cves) {
    let modCves = Object.values(cves);
    modCves = modCves.map(cve => {
        return {
            impact: processImpactForTable(cve.impact),
            synopsis: processSynopsisForTable(cve.synopsis),
            systems: processSystemsForTable(cve.systems),
            total_risk: processRiskForTable(cve.impact, false),
            description: truncate(cve.description, 200)
        };
    });
    let table = modCves.map(cve => {
        return { cells: Object.values(cve), synopsis: cve.synopsis.props.children };
    });
    return table;
}

function getAffectedSystems(cve) {
    let systems = getDemoCVESystem()
    .filter(item => {
        return item.cve === cve;
    })
    .map(single => single.system);
    return systems;
}

export function createExposedSystemsTable(cves) {
    if (cves.isLoading) {
        return;
    }

    let singleCve = cves.items[0];
    let affectedSystems = [...new Set(getAffectedSystems(singleCve.synopsis))];
    return affectedSystems.map(system => {
        let icon = <LaptopIcon size="lg" />;
        let impact = processImpactForTable(singleCve.impact, false);
        return { cells: [impact, icon, system] };
    });
}

export function createCveDetailsPage(cves) {
    if (_.isEmpty(cves.items)) {
        return {
            impact: '',
            public_date: '',
            description: '',
            synopsis: '',
            errata_list: [],
            isLoading: true
        };
    }

    let singleCve = cves.items[0];
    let isLoading = cves.isLoading;
    return {
        impact: processImpactForTable(singleCve.impact),
        public_date: processDate(singleCve.public_date),
        description: singleCve.description,
        synopsis: singleCve.synopsis,
        errata_list: singleCve.errata_list.map(item => <li key={item}>{item}</li>),
        package_list: singleCve.package_list.map(item => <li key={item}>{item}</li>),
        isLoading
    };
}

export function withLoader(prop, isLoading) {
    if (isLoading !== false) {
        return (
            <Bullseye>
                <PropagateLoader color={'#00b9e4'} loading={true} />
            </Bullseye>
        );
    } else {
        return prop;
    }
}

function processSynopsisForTable(synopsis) {
    return <b>{synopsis}</b>;
}

function truncate(str, max) {
    return str.length > max ? str.substr(0, max - 1) + 'â€¦' : str;
}

function processSystemsForTable(number) {
    return (
        <React.Fragment>
            <div style={{ width: '120px' }}>
                <span style={{ textAlign: 'center', display: 'block' }}>
                    <b>{number}</b>
                </span>
                Systems/Groups
            </div>
        </React.Fragment>
    );
}

function optimizeCveList(cveList) {
    return cveList;
}

export function processRawCVEs(rawcves) {
    let cveItems = [];
    for (let row in rawcves.cve_list) {
        let newRow = processCVErow(row, rawcves.cve_list[row]);
        cveItems.push(newRow);
    }

    return {
        ...cveItems
    };
}

function processCVErow(key, data) {
    let modifiedData = {
        ...data,
        synopsis: data.synopsis,
        cwe_list: data.cwe_list,
        public_date: data.public_date,
        modified_date: data.modified_date,
        impact: data.impact,
        redhat_url: data.redhat_url,
        secondary_url: data.secondary_url,
        errata_list: data.errata_list,
        package_list: data.package_list
    };
    return modifiedData;
}

function processDate(dateString) {
    let date = new Date(dateString);
    return date.toLocaleDateString();
}

function processRiskForTable(impact, hiddenLabel = false) {
    let icon;
    switch (impact) {
        case 'High':
        case 'Important':
            icon = <Battery label="Important" severity="high" labelHidden={hiddenLabel} />;
            break;
        case 'Medium':
        case 'Moderate':
            icon = <Battery label="Medium" severity="medium" labelHidden={hiddenLabel} />;
            break;
        case 'Critical':
            icon = <Battery label="Critical" severity="critical" labelHidden={hiddenLabel} />;
            break;
        case 'Low':
            icon = <Battery label="Low" severity="low" labelHidden={hiddenLabel} />;
            break;
    }

    return icon;
}

function processImpactForTable(impact) {
    let icon;
    switch (impact) {
        case 'High':
        case 'Important':
            icon = <ExclamationTriangleIcon size="lg" color="#ec7a08" />;
            break;
        case 'Medium':
        case 'Moderate':
            icon = <ExclamationTriangleIcon size="lg" color="var(--pf-global--warning-color--100)" />;
            break;
        case 'Critical':
            icon = <ExclamationTriangleIcon size="lg" color="var(--pf-global--danger-color--100)" />;
            break;
        case 'Low':
            icon = <ExclamationTriangleIcon size="lg" color="var(--pf-global--BackgroundColor--disabled)" />;
            break;
    }

    return (
        <span>
            <Alignment align="center">{icon}</Alignment>
        </span>
    );
}

function getDemoCVESystem() {
    return [
        {
            system: 'spirit.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'kickapoo.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'cypress.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'kissimmee.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'sevuer.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'candlewood.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'leech.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'sabine.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'sutton.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'sawtooth.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'erie.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'trinity.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'sinclair.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'cumberland.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'lurleen.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'donner.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'spirit.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'verret.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'eagle.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'ute.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'tule.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'pleasant.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'cedar.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'erie.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'higgins.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'enid.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'sinclair.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'ute.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'placid.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'mono.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'saugatuck.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'higgins.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'sawtooth.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'liberty.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'minnetonkas.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'cowan.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'patoka.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'peck.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'walloon.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'bantam.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'bluewater.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'shasta.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'stump.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'champlain.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'crescent.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'marion.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'greeson.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'hauser.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'zoar.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'sunapee.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'hauser.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'salton.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'harris.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'rush.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'pleasant.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'tupper.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'cypress.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'huron.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'navajo.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'saugatuck.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'sabine.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'verret.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'tule.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'gull.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'sunapee.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'harris.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'sawtooth.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'cypress.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'claytor.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'minnetonkas.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'cumberland.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'tygart.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'ute.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'heron.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'como.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'sevuer.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'storm.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'eagle.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'michigan.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'peck.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'ontario.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'george.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'huron.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'placid.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'cumberland.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'perry.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'leech.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'summer.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'degray.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE_2016_3714'
        },
        {
            system: 'greers.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'tahoe.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'greenbo.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'harris.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'como.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'kickapoo.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'crystal.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'beshear.example.redhat.com',
            cve: 'CVE-2017-1000502'
        },
        {
            system: 'como.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'pyramid.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'elwell.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'baron.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'lurleen.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'bluewater.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'seeley.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'gull.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'stump.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'higgins.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'fairfax.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'elwell.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'locust.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'saugatuck.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'spirit.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'storm.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'pyramid.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'emporia.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'harding.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'greenbo.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'pleasant.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'como.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'navajo.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'hartwell.example.redhat.com',
            cve: 'CVE-2018-10908'
        },
        {
            system: 'rend.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'rush.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'cowan.example.redhat.com',
            cve: 'CVE-2017-5715'
        },
        {
            system: 'ozarks.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'ute.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'sunapee.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'rico.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'beaver.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'rico.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'greers.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'placid.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'pleasant.example.redhat.com',
            cve: 'CVE_2015_3456'
        },
        {
            system: 'salton.example.redhat.com',
            cve: 'CVE-2014-0160'
        },
        {
            system: 'rico.example.redhat.com',
            cve: 'CVE_2015_7547'
        },
        {
            system: 'seeley.example.redhat.com',
            cve: 'CVE-2017-5753'
        },
        {
            system: 'pyramid.example.redhat.com',
            cve: 'CVE-2017-5756'
        },
        {
            system: 'stump.example.redhat.com',
            cve: 'CVE-2018-1102'
        },
        {
            system: 'bantam.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'peck.example.redhat.com',
            cve: 'CVE-2016-0800'
        },
        {
            system: 'storm.example.redhat.com',
            cve: 'CVE-2017-5754'
        },
        {
            system: 'sevuer.example.redhat.com',
            cve: 'CVE-2018-4117'
        },
        {
            system: 'sakakawea.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'walker.example.redhat.com',
            cve: 'CVE-2018-10931'
        },
        {
            system: 'sardis.example.redhat.com',
            cve: 'CVE-2018-2814'
        },
        {
            system: 'crystal.example.redhat.com',
            cve: 'CVE_2016_3714'
        }
    ];
}
