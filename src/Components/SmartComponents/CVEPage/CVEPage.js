import { Grid, GridItem } from '@patternfly/react-core';
import { routerParams } from '@red-hat-insights/insights-frontend-components';
import propTypes from 'prop-types';
import React from 'react';
import { connect } from 'react-redux';
import { dispatchAction } from '../../../Helpers/MiscHelp';
import { fetchAffectedSystemsByCVE, fetchCveDetails } from '../../../Store/Actions/CVEActions';
import { sCveDetailsPage, sExposedSystemsTable } from '../../../Store/Selectors/CVESelectors';
import CVEPageDetails from '../../PresentationalComponents/CVEPageDetails/CVEPageDetails';
import SystemsExposedTable from '../SystemsExposedTable/SystemsExposedTable';

class CVEPage extends React.Component {
    constructor(props) {
        super(props);
    }

    componentDidMount() {
        let cveName = this.props.match.params.cve;
        this.props.fetchCveDetails(cveName);
        this.props.fetchAffectedSystems(cveName);
    }
    render() {
        return (
            <React.Fragment>
                <Grid gutter="sm">
                    <GridItem span={12}>
                        <CVEPageDetails data={this.props.cveDetails} />
                    </GridItem>
                    <GridItem span={12}>
                        <SystemsExposedTable affectedBy={this.props.cveTableRows} />
                    </GridItem>
                </Grid>
            </React.Fragment>
        );
    }
}

function mapStateToProps(state) {
    return {
        cveDetails: sCveDetailsPage(state),
        cveTableRows: sExposedSystemsTable(state)
    };
}

const mapDispatchToProps = dispatch => {
    return {
        fetchCveDetails: cveName => dispatchAction(fetchCveDetails(cveName), dispatch),
        fetchAffectedSystems: cveName => dispatchAction(fetchAffectedSystemsByCVE(cveName), dispatch)
    };
};

CVEPage.propTypes = {
    match: propTypes.object,
    cveDetails: propTypes.object,
    fetchCveDetails: propTypes.func
};

export default routerParams(
    connect(
        mapStateToProps,
        mapDispatchToProps
    )(CVEPage)
);
